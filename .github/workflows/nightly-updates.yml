name: Nightly Update to Data Display

on: 
  schedule:
    - cron:  '0 0 * * *'
  workflow_dispatch:
  pull_request:

env:
  RECO: "/work/eic2/EPIC/RECO"
  FULL: "/work/eic2/EPIC/FULL"
  XROOTD_HOST: root://dtn-eic.jlab.org
  REPOSITORY: "${{github.repository}}"

jobs:
  campaigns_reco:
    runs-on: ubuntu-latest
    outputs:
      campaigns: ${{ steps.campaigns_reco.outputs.campaigns }}

    container:
      image: rucio/xrootd

    steps:
      - name: List campaigns
        id: campaigns_reco
        shell: bash
        run: |
          mapfile -t campaigns < <(xrdfs ${XROOTD_HOST} ls ${RECO} | awk -F'/' '{print $NF}' | sort -n)

          # Check if campaigns are found
          if [ ${#campaigns[@]} -eq 0 ]; then
            echo "No campaigns found for type: reco"
          fi

          # Convert array to JSON format for output
          campaigns_json="["$(IFS=,; echo "${campaigns[*]}")"]"

          # Output campaigns as a JSON array
          echo "campaigns=${campaigns_json}" >> $GITHUB_OUTPUT

      - name: Print outputs
        run: |
          echo "Reco campaigns:"
          echo "${{ steps.campaigns_reco.outputs.campaigns }}"

  process_campaigns:
    needs: campaigns_reco
    runs-on: ubuntu-latest
    strategy:
      matrix:
        campaign: ${{ fromJson(needs.campaigns_reco.outputs.campaigns) }}
    steps:
      - name: Process campaign
        run: |
          echo "Processing campaign: ${{ matrix.campaign }}"
          # Add your processing logic here
          
